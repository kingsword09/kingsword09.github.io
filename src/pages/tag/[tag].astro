---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { withBase } from "../../utils/urls";
import { formatPostDate } from "../../utils/dates";
import { getPostUrl, sortPostsDesc } from "../../utils/posts";

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  const tags = new Set<string>();
  for (const post of posts) {
    for (const tag of post.data.tags) tags.add(tag);
  }

  return Array.from(tags).map((tag) => ({
    params: { tag },
  }));
}

const { tag } = Astro.params;
const posts = sortPostsDesc(
  (await getCollection("posts")).filter((p) => p.data.tags.includes(tag))
);
---

<BaseLayout title={`Tag #${tag}`}>
  <section class="posts">
    <div class="flex-row-between">
      <h1>Tag #{tag}</h1>
      <a href={withBase("/")}>
        <i class="fa fa-home" aria-hidden="true"></i> Home
      </a>
    </div>

    <ul>
      {posts.map((post) => (
        <li>
          <a class="post" href={getPostUrl(post)}>{post.data.title}</a>
          <time datetime={post.data.pubDate.toISOString()}>{formatPostDate(post.data.pubDate)}</time>
        </li>
      ))}
    </ul>
  </section>
</BaseLayout>

